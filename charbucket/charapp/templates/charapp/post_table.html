{% extends 'charapp/charapp_base.html' %}
{% block content %}
<script>
    tinymce.init({
        selector:'#whiteboard',
        });
</script>
<div class="card m-3">
    <div class="card-header">
        <p>{{post.title}} - {{post.user}}</p>
    </div>
    <div class="card-body d-flex">

        <textarea class="card-text col" id="whiteboard" size="lg">
            {{post.text|safe}}
        </textarea>
        
        <div>
            <ul id="comment_block" class="list-group list-group-flush">
                {% for comment in post.comments.all %}
                <li class="list-group-item">{{comment}}</li>
                {% endfor %}
            </ul>
            <input id = "comment_input" type = "text"/>
            <br>
            <!-- <input id = "comment_submit" type="button" value="Send"/> -->
            <button id="comment_submit">Send</button>
        </div>
        <div>
            <textarea id="test_display"></textarea>
        </div>
        

    </div>
</div>
<script type="text/javascript">

    let commSocket = new WebSocket(
        'ws://' + window.location.host + 
        '/ws/charapp/table/{{post.id}}/'
    );

    commSocket.onmessage = function(e) {
        console.log('hello')
        let data = JSON.parse(e.data);
        let message = data['message'];
        let comment = document.createElement('li');
        let commentText = document.createTextNode(message);
        comment.appendChild(commentText);
        document.querySelector('#comment_block').appendChild(comment);
        document.querySelector('#test_display').innerText += (message + '\n')
    }

    commSocket.onclose = function(e) {
        console.error('Websocket closed unexpectedly');
    };

    // document.querySelector('#comment_submit').onkeyup = function(e) {
    //     if (e.keycode === 13) {
    //         document.querySelector('#comment_submit').click();
    //     }
    // };

    // console.log(document.querySelector('#comment_submit')

    let comment_submit = document.querySelector('#comment_submit')
    console.log(comment_submit)
    

    comment_submit.onclick = function(e) {
        let messageInput = document.querySelector('#comment_input');
        let message = messageInput.value;
        commSocket.send(JSON.stringify({
            'message': message
        }));
        messageInput.value = ''
    }


</script>
{% endblock%}